name: Windows MSVC Release
on: 
  push:
    tags:
      - "*"

jobs:
  build_and_release:
    strategy:
      matrix:
        include:
          - name: win64_msvc
            os: windows-2019
            build_type: Release
            compiler_type: msvc2019_64
            msvc_arch: x64
            qt_arch: win64_msvc2019_64
            qt_version: 5.15.2
            qt_target: desktop
    runs-on: ${{ matrix.os }}
    env:
      BUILD_TYPE: ${{ matrix.build_type }}
      COMPILER_TYPE: ${{ matrix.compiler_type }}
      QT_VERSION: ${{ matrix.qt_version }}
      OPENSSL_ROOT_DIR: C:\Program Files\OpenSSL
    steps:
      # force 6.2.2 version of Inno Setup
      - name: Install Inno Setup
        run: |
          choco install innosetup --version 6.2.2 --allow-downgrade -y

      - name: '⚙️ Cache Qt'
        id: cache-qt
        uses: actions/cache@v3
        with:
          path: ..\Qt
          key: Windows-QtCache-${{ env.QT_VERSION }}

      - name: Install Qt ${{ env.QT_VERSION }}
        uses: jurplel/install-qt-action@v3
        with:
          aqtversion: '==3.1.*'
          version: ${{ env.QT_VERSION }}
          target: ${{ matrix.qt_target }}
          arch: ${{ matrix.qt_arch }}
          # cached: 'false'
          cached: ${{ steps.cache-qt.outputs.cache-hit }}

      # 3.20.0 高版本无法找到OPENSSL和ZLIB
      - name: Setup cmake
        uses: lukka/get-cmake@latest
        with:
          cmakeVersion: 3.20.0
          ninjaVersion: 1.11.1

      - name: Checkout
        uses: actions/checkout@v4
        with:
          path: ''
          fetch-depth: 0

      - name: msvc-build
        id: build
        shell: cmd
        env:
          vc_arch: ${{ matrix.msvc_arch }}
          cmake_gen: Visual Studio 16 2019
        run: |
          call workflow_msvc_build.bat

      - name: Make Installer Directories
        run: |
          powershell -Command "Compress-Archive -Path build/installer-inno/dde-cooperation/* -DestinationPath build/installer-inno/dde-cooperation.zip"
          powershell -Command "Compress-Archive -Path build/installer-inno/data-transfer/* -DestinationPath build/installer-inno/deepin-data-transfer.zip"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: build/installer-inno/*.zip
          generate_release_notes: true
          draft: true
